<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <title>搜索</title>
    <meta charset="utf-8" />
    <meta name="viewport"
        content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <style>
        body {
            max-width: 512px;
            padding: 2%;
            margin-left: auto;
            margin-right: auto;
        }

        img {
            max-width: 100%;
        }

        input {
            width: 100%;
        }
    </style>
</head>

<body>
    <script>
        xmlhttp = new XMLHttpRequest()
        xmlhttp.open('GET', 'all.json', false)
        xmlhttp.send()
        if (xmlhttp.status == 200) {
            input_all = JSON.parse(xmlhttp.responseText)
        } else {
            document.write('<h1>Http Error</h1>')
            document.write(xmlhttp.status)
        }
        var title = document.createElement('h1')
        var list = document.createElement('div')
        var input = document.createElement('div')
        input.align = 'right'
        var input_key = document.createElement('input')
        input_key.type = 'text'
        input.appendChild(input_key)
        var input_botton = document.createElement('button')
        input_botton.innerText = '查看搜索结果'
        input_botton.onclick = function () {
            window.location.hash = '#' + encodeURI(input_key.value)
        }
        input.appendChild(input_botton)
        var input_info = document.createElement('p')
        input_info.innerText='输入图片标题或简介(正则表达式)进行模糊搜索(不区分大小写),\
        \n输入 PID 进行精确查找(区分大小写),\
        \n输入 $+日期 查询单日图片(如 $2019-10-06),\
        \n输入 @+用户名 对单独用户进行查找(区分大小写, 如 @Chimon89).\
        \n以上所有情况同时生效,\
        \n如: 当搜索 @abc 时, 若图片简介中恰含 @abc , 也将显示在搜索结果中.'
        var res_bar = document.createElement('div')
        res_bar.align = 'right'
        var msg = document.createElement('p')
        res_bar.appendChild(msg)
        input.appendChild(msg)
        input.appendChild(input_info)
        var back_button = document.createElement('button')
        back_button.innerText = '返回'
        back_button.onclick = function () {
            window.location.hash = '#'
        }
        res_bar.appendChild(back_button)
        document.body.appendChild(title)
        document.body.appendChild(input)
        document.body.appendChild(list)
        function getResult(key){
            r = new Array()
            try {
                reg = RegExp(key.toLowerCase())
            } catch (error) {
                retrun r
            }
            for (k1 in input_all['date']) {
                for (k2 in input_all['date'][k1]) {
                    pic = input_all['date'][k1][k2]
                    d = (pic['p_title'] + pic['p_content']).toLowerCase()
                    if (d.match(reg) ||
                     pic['PID'] == key || 
                     ('$'+pic['p_date']) == key ||
                     ('@'+pic['username']) == key) {
                        r.push(pic)
                    }
                }
            }
            return r
        }
        //var key_word2 = ''
        function search() {
            list.appendChild(res_bar)
            key_word = input_key.value
            sort_map = input_all['sort_map']
            if (key_word == '') {
                //input_key.value = key_word2
                document.title = '搜索'
                title.innerText = '搜索'
                list.innerHTML = ''
                //document.body.appendChild(input)
                input.style.display = 'block'
                res_bar.remove()
                return
            }
            //key_word2 = key_word
            document.title = '搜索:' + key_word
            title.innerText = '搜索:' + key_word
            //input.remove()
            input.style.display = 'gone'
            pics = getResult(key_word)
            for (k in pics){
                addResult(pics[k],sort_map)
            }
            re_count = list.children.length - 1
            if (re_count == 0) {
                msg.innerText = '没有找到符合要求的图片'
            } else {
                msg.innerText = '共有 ' + re_count + ' 个结果'
            }
        }
        function addResult(pic, sort) {
            var item = document.createElement('div')
            var p_title = document.createElement('h2')
            p_title.innerText = pic['p_title']
            item.appendChild(p_title)
            var info = document.createElement('p')
            var detail_a = document.createElement('a')
            detail_a.target = '_blank'
            detail_a.href = pic['PID'] + '.html'
            detail_a.innerText = '详情'
            info.appendChild(detail_a)
            var detail_info = document.createElement('small')
            detail_info.innerText = pic.p_date + ' ' + sort[pic.TID]['T_NAME'] + ' @' + pic['username']
            info.appendChild(detail_info)
            item.appendChild(info)
            var content = document.createElement('p')
            content.innerText = pic['p_content']
            item.appendChild(content)
            var img = document.createElement('img')
            img.src = pic['PID'] + '-lite.jpg'
            img.alt = pic['p_title']
            item.appendChild(img)
            var hr = document.createElement('hr')
            item.appendChild(hr)
            list.appendChild(item)
        }

        input_key.value = decodeURI(window.location.hash.replace('#', ''))
        search()

        window.addEventListener('popstate', function (e) {
            input_key.value = decodeURI(window.location.hash.replace('#', ''))
            search()
        })

        input_key.addEventListener('keypress', function (e) {
            if (e.keyCode == 13) {
                input_botton.click()
            }
        })

        input_key.addEventListener('input', function (e) {
            key_word = input_key.value
            if (key_word == '') {
                msg.innerText = ''
                return
            }
            r_c = getResult(key_word).length
            if (r_c == 0) {
                msg.innerText = '没有找到符合要求的图片'
            } else {
                msg.innerText = '共有 ' + r_c + ' 个结果'
            }
        })

    </script>
</body>

</html>
