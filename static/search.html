<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <title>搜索</title>
    <meta charset="utf-8" />
    <meta name="viewport"
        content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <style>
        body {
            max-width: 512px;
            padding: 2%;
            margin-left: auto;
            margin-right: auto;
        }

        img {
            max-width: 100%;
        }
    </style>
</head>

<body>
    <script>
        xmlhttp = new XMLHttpRequest()
        xmlhttp.open('GET', 'all.json', false)
        xmlhttp.send()
        if (xmlhttp.status == 200) {
            input_all = JSON.parse(xmlhttp.responseText)
        } else {
            document.write('<h1>Http Error</h1>')
            document.write(xmlhttp.status)
        }
        var title = document.createElement('h1')
        title.innerText = '搜索'
        var list = document.createElement('div')
        var input = document.createElement('div')
        var input_key = document.createElement('input')
        input_key.type = 'text'
        input_key.style = 'width: 100%'
        input.appendChild(input_key)
        var input_botton = document.createElement('button')
        input_botton.style = 'float:right'
        input_botton.innerText = '搜索'
        document.body.appendChild(title)
        document.body.appendChild(input)
        document.body.appendChild(list)
        input.appendChild(input_botton)
        input_botton.onclick = function () {
            window.location.hash = '#' + encodeURI(input_key.value)
            search()
        }
        function search() {
            key_word = input_key.value
            sort_map = input_all['sort_map']
            if (key_word == '') {
                document.title = '搜索'
                title.innerText = '搜索'
                list.innerHTML = ''
                document.body.appendChild(title)
                document.body.appendChild(input)
                return
            }
            document.title = '搜索:' + key_word
            title.innerText = key_word
            input.remove()
            reg = RegExp(key_word.toLowerCase())
            for (k1 in input_all['date']) {
                for (k2 in input_all['date'][k1]) {
                    pic = input_all['date'][k1][k2]
                    d = (pic['p_title'] + pic['p_content']).toLowerCase()
                    if (d.match(reg)) {
                        addResult(pic, sort_map)
                    }
                }
            }
        }
        function addResult(pic, sort) {
            var item = document.createElement('div')
            var title = document.createElement('h2')
            title.innerText = pic['p_title']
            item.appendChild(title)
            var info = document.createElement('p')
            var detail_a = document.createElement('a')
            detail_a.target = '_blank'
            detail_a.href = pic['PID'] + '.html'
            detail_a.innerText = '详情'
            info.appendChild(detail_a)
            var detail_info = document.createElement('small')
            detail_info.innerText = pic.p_date + ' ' + sort[pic.TID]['T_NAME'] + ' @' + pic['username']
            info.appendChild(detail_info)
            item.appendChild(info)
            var content = document.createElement('p')
            content.innerText = pic['p_content']
            item.appendChild(content)
            var img = document.createElement('img')
            img.src = pic['PID'] + '-lite.jpg'
            img.alt = pic['p_title']
            item.appendChild(img)
            var hr = document.createElement('hr')
            item.appendChild(hr)
            list.appendChild(item)
        }

        window.addEventListener('popstate', function (e) {
            input_key.value = decodeURI(window.location.hash.replace('#', ''))
            search()
        })

        input_key.addEventListener('keypress', function (e) {
            if (e.keyCode == 13) {
                input_botton.click()
            }
        })

    </script>
</body>

</html>